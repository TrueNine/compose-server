---
description: Kotlin æµ‹è¯•è§„èŒƒä¸æœ€ä½³å®è·µæŒ‡å—
globs: *Test.kt,*Test.java
alwaysApply: false
---

## æµ‹è¯•è§„èŒƒ

- å•å…ƒæµ‹è¯•è¦†ç›–ç‡å¿…é¡»è¾¾åˆ° 100%
- å¿…é¡»åŒ…å«å……åˆ†çš„è¾¹ç•Œæ¡ä»¶
- å¯¹æµ‹è¯•ä½¿ç”¨åˆç†çš„åˆ†ç»„

# Kotlin æµ‹è¯•è§„èŒƒä¸æœ€ä½³å®è·µ ğŸ§ª

## æŠ€æœ¯æ ˆ ğŸ› 

- æµ‹è¯•æ¡†æ¶ï¼šJUnit 5 + kotlin.test
- Mock æ¡†æ¶ï¼šMockKï¼ˆé¦–é€‰ï¼‰/ Mockitoï¼ˆJava äº’æ“ä½œæ—¶ï¼‰
- å‚æ•°åŒ–æµ‹è¯•ï¼šJUnit 5 Params
- é›†æˆæµ‹è¯•ï¼šTestcontainers
- Spring æµ‹è¯•ï¼šspring-boot-test

## å‘½åè§„èŒƒ ğŸ“

### æµ‹è¯•ç±»å‘½å

- å•å…ƒæµ‹è¯•ï¼š`[ç±»å]Test`
- é›†æˆæµ‹è¯•ï¼š`[ç±»å]IntegrationTest`
- æ€§èƒ½æµ‹è¯•ï¼š`[ç±»å]PerfTest`

### æµ‹è¯•æ–¹æ³•å‘½å

ä½¿ç”¨åå¼•å·åŒ…è£¹ï¼Œé‡‡ç”¨ä¸­æ–‡æè¿°æ€§å‘½åï¼š

```kotlin
@Test
fun `å½“ç”¨æˆ·æ˜¯ç®¡ç†å‘˜æ—¶ï¼Œæ‹¥æœ‰å®Œæ•´è®¿é—®æƒé™`() {}
```

å‘½åæ¨¡å¼ï¼š
- æ­£å‘æµ‹è¯•ï¼š`å½“ [æ¡ä»¶] æ—¶ï¼Œ[é¢„æœŸç»“æœ]`
- å¼‚å¸¸æµ‹è¯•ï¼š`å½“ [å¼‚å¸¸æ¡ä»¶] æ—¶ï¼ŒæŠ›å‡º [å¼‚å¸¸ç±»å‹]`
- è¾¹ç•Œæµ‹è¯•ï¼š`å½“ [è¾¹ç•Œæ¡ä»¶] æ—¶ï¼Œ[é¢„æœŸç»“æœ]`
- æ€§èƒ½æµ‹è¯•ï¼š`éªŒè¯ [åŠŸèƒ½] æ€§èƒ½è¾¾åˆ° [æŒ‡æ ‡]`

## Kotlin æµ‹è¯•ç¼–å†™è§„èŒƒ âœ¨

### åŸºæœ¬åŸåˆ™

1. å……åˆ†åˆ©ç”¨ Kotlin ç‰¹æ€§ï¼š
```kotlin
// ä½¿ç”¨æ•°æ®ç±»
data class TestUser(val id: String, val role: String)

// ä½¿ç”¨è§£æ„
val (id, role) = TestUser("1", "admin")

// ä½¿ç”¨æ‰©å±•å‡½æ•°
fun TestUser.hasAdminAccess() = role == "admin"
```

2. æµ‹è¯•ç»“æ„ç»„ç»‡ï¼š
```kotlin
class UserServiceTest {
  private lateinit var userService: UserService
  private val mockRepo = mockk<UserRepository>()

  @BeforeEach
  fun setup() {
    userService = UserService(mockRepo)
  }

  @Nested
  inner class CreateUser {
    @Test
    fun `å½“è¾“å…¥æœ‰æ•ˆæ—¶ï¼Œåˆ›å»ºç”¨æˆ·`() {
      val input = UserInput("test@email.com")
      val result = userService.createUser(input)
      assertNotNull(result)
      assertEquals("test@email.com", result.email)
    }
  }
}
```

### MockK ä½¿ç”¨è§„èŒƒ

```kotlin
// æ¨èå†™æ³•
every { mockRepo.findById(any<T>()) } returns user
verify(exactly = 1) { mockRepo.save(any<T>()) }

// åç¨‹æ”¯æŒ
coEvery { mockRepo.suspendFindById(any<T>()) } returns user
coVerify { mockRepo.suspendSave(any<T>()) }
```

### æ–­è¨€æœ€ä½³å®è·µ

```kotlin
// ä½¿ç”¨ kotlin.test æ–­è¨€
assertEquals(expected, actual)
assertIs<UserType>(user)
assertFailsWith<IllegalArgumentException> { 
  userService.createUser(invalidInput)
}

// é›†åˆæ–­è¨€
assertContains(users, expectedUser)
assertTrue(users.all { it.isActive })
```

## å‚æ•°åŒ–æµ‹è¯• ğŸ“Š

```kotlin
@ParameterizedTest
@CsvSource(
  "ADMIN, true",
  "USER, false",
  "GUEST, false"
)
fun `verify user access based on role`(
  role: String,
  expectedAccess: Boolean
) {
  val user = User(role = role)
  assertEquals(expectedAccess, user.hasAccess())
}
```

## é›†æˆæµ‹è¯•è§„èŒƒ ğŸ”„

```kotlin
@SpringBootTest
class UserIntegrationTest {
  lateinit var userService: UserService @Resource set

  @Container
  val postgres = PostgreSQLContainer<Nothing>("postgres:14").apply {
    withDatabaseName("testdb")
  }

  @Test
  fun `éªŒè¯ç”¨æˆ·æŒä¹…åŒ–`() = runTest {
    // æµ‹è¯•å®ç°
  }
}
```

## æµ‹è¯•è¦†ç›–ç‡è¦æ±‚ ğŸ“ˆ

- å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 100%
- å…³é”®ä¸šåŠ¡é€»è¾‘è¦†ç›–ç‡ > 100%
- å¼‚å¸¸åˆ†æ”¯å¿…é¡»è¦†ç›–
- è¾¹ç•Œæ¡ä»¶å¿…é¡»æµ‹è¯•

## æ•…éšœæ’æŸ¥æŒ‡å— ğŸ”

- æ€§èƒ½é—®é¢˜ï¼š
  + ä½¿ç”¨ JVM åˆ†æå·¥å…·
  + æ£€æŸ¥èµ„æºä½¿ç”¨æƒ…å†µ
  + å¯¹æ¯”å†å²æ€§èƒ½æ•°æ®

## æœ€ä½³å®è·µæç¤º ğŸ’¡

- ä¿æŒæµ‹è¯•ç®€å•ã€æ¸…æ™°
- ä¸€ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªè¡Œä¸º
- é¿å…æµ‹è¯•é—´çš„ä¾èµ–
- åˆç†ä½¿ç”¨æµ‹è¯•å¤¹å…·
- åŠæ—¶æ¸…ç†æµ‹è¯•èµ„æº
- å®šæœŸé‡æ„æµ‹è¯•ä»£ç 
- ä¿æŒæµ‹è¯•ä»£ç è´¨é‡ä¸äº§å“ä»£ç åŒç­‰é‡è¦