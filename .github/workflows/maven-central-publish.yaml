name: Publish to Maven Central

on:
  push:
    branches: [ main ]
    tags:  [ 'ðŸš€*' ]
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      dry_run:
        description: 'æ˜¯å¦æ‰§è¡Œè¯•è¿è¡Œï¼ˆä¸å®žé™…å‘å¸ƒï¼‰'
        type: boolean
        default: false
      force_publish:
        description: 'å¼ºåˆ¶å‘å¸ƒï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æµ‹ï¼‰'
        type: boolean
        default: false
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•ï¼ˆä»…ç”¨äºŽç´§æ€¥å‘å¸ƒï¼‰'
        type: boolean
        default: false

# å¹¶å‘æŽ§åˆ¶ï¼šé˜²æ­¢åŒæ—¶è§¦å‘å¤šä¸ªå‘å¸ƒä»»åŠ¡
concurrency:
  group: maven-publish-${{ github.ref }}
  cancel-in-progress: false

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4 -Dorg.gradle.configuration-cache=true"
  JVM_OPTS: "-Xmx4g -XX:MaxMetaspaceSize=1536m -XX:+UseG1GC -XX:G1HeapRegionSize=16m"

jobs:
  # ðŸ§ª å‘å¸ƒå‰éªŒè¯
  pre-publish-validation:
    name: "ðŸ§ª Pre-publish Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      version: ${{ steps.version-info.outputs.version }}
      is-snapshot: ${{ steps.version-info.outputs.is-snapshot }}
      should-publish: ${{ steps.version-info.outputs['should-publish'] }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'graalvm'
          cache: gradle

      - name: Cache Gradle wrapper
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-wrapper-

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/jdks
            ~/.gradle/buildOutputCleanup
            ~/.gradle/kotlin
            ~/.konan
            ~/.m2/repository
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
          save-always: true

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.0.0'

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Extract version information
        id: version-info
        run: |
          # è¯­ä¹‰åŒ–ç‰ˆæœ¬éªŒè¯å‡½æ•°
          validate_semver() {
            local version="$1"
            # æ”¯æŒæ ‡å‡†è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ¼å¼ï¼šx.y.z[-prerelease][+build]
            if [[ "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.-]+)?(\+[a-zA-Z0-9\.-]+)?$ ]]; then
              return 0
            else
              return 1
            fi
          }

          # ç¡®å®šå½“å‰ç‰ˆæœ¬
          echo "ðŸ” ç¡®å®šå‘å¸ƒç‰ˆæœ¬..." >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            version="${{ github.event.inputs.version }}"
            echo "ðŸ“ æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬: $version" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            version="${{ github.event.release.tag_name }}"
            version=${version#v}  # ç§»é™¤å¯èƒ½çš„ 'v' å‰ç¼€
            echo "ðŸ·ï¸ Release æ ‡ç­¾ç‰ˆæœ¬: $version" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            version="${{ github.ref_name }}"
            version=${version#v}  # ç§»é™¤å¯èƒ½çš„ 'v' å‰ç¼€
            echo "ðŸ·ï¸ æ ‡ç­¾è§¦å‘ç‰ˆæœ¬: $version" >> $GITHUB_STEP_SUMMARY
          else
            # push event: parse from libs.versions.toml
            version=$(sed -n 's/^project\s*=\s*"\(.*\)"/\1/p' gradle/libs.versions.toml | head -n1)
            echo "ðŸ“„ ä»Ž libs.versions.toml è¯»å–ç‰ˆæœ¬: $version" >> $GITHUB_STEP_SUMMARY
          fi

          # éªŒè¯ç‰ˆæœ¬æ ¼å¼
          if ! validate_semver "$version"; then
            echo "âŒ ç‰ˆæœ¬æ ¼å¼æ— æ•ˆ: $version" >> $GITHUB_STEP_SUMMARY
            echo "ç‰ˆæœ¬å¿…é¡»ç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒ (x.y.z[-prerelease][+build])" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "version=$version" >> $GITHUB_OUTPUT
          echo "âœ… ç‰ˆæœ¬æ ¼å¼éªŒè¯é€šè¿‡: $version" >> $GITHUB_STEP_SUMMARY

          # ç¡®å®šå¿«ç…§çŠ¶æ€
          if [[ "$version" == *"-SNAPSHOT" ]] || [[ "$version" == *"-alpha"* ]] || [[ "$version" == *"-beta"* ]] || [[ "$version" == *"-rc"* ]]; then
            echo "is-snapshot=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ é¢„å‘å¸ƒç‰ˆæœ¬ç±»åž‹" >> $GITHUB_STEP_SUMMARY
          else
            echo "is-snapshot=false" >> $GITHUB_OUTPUT
            echo "ðŸš€ æ­£å¼å‘å¸ƒç‰ˆæœ¬ç±»åž‹" >> $GITHUB_STEP_SUMMARY
          fi

          # ç®€åŒ–çš„å‘å¸ƒå†³ç­–é€»è¾‘
          should_publish="false"
          force_publish="${{ github.event.inputs.force_publish }}"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” å‘å¸ƒå†³ç­–åˆ†æž..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # å¼ºåˆ¶å‘å¸ƒæ¨¡å¼
          if [[ "$force_publish" == "true" ]]; then
            should_publish="true"
            echo "âš¡ **å¼ºåˆ¶å‘å¸ƒæ¨¡å¼å·²å¯ç”¨**" >> $GITHUB_STEP_SUMMARY
          # æ˜Žç¡®çš„å‘å¸ƒè§¦å‘å™¨
          elif [[ "${{ github.ref_type }}" == "tag" ]] || [[ "${{ github.event_name }}" == "release" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            should_publish="true"
            echo "ðŸŽ¯ **ç›´æŽ¥è§¦å‘**ï¼šæ ‡ç­¾/Release/æ‰‹åŠ¨è§¦å‘ - å°†å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
          # main åˆ†æ”¯ pushï¼šæ£€æŸ¥ç‰ˆæœ¬å˜åŒ–
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ðŸŒ± **Main åˆ†æ”¯ push**ï¼šæ£€æŸ¥ç‰ˆæœ¬å˜åŒ–..." >> $GITHUB_STEP_SUMMARY
          
            # ä½¿ç”¨æ›´ç®€å•çš„ç‰ˆæœ¬æ£€æŸ¥æ–¹æ³•
            if git diff HEAD~1 --name-only | grep -q "gradle/libs.versions.toml"; then
              prev_version=$(git show HEAD~1:gradle/libs.versions.toml 2>/dev/null | sed -n 's/^project\s*=\s*"\(.*\)"/\1/p' | head -n1 || echo "unknown")
              if [[ "$prev_version" != "$version" && "$prev_version" != "unknown" ]]; then
                should_publish="true"
                echo "  ðŸ”¼ æ£€æµ‹åˆ°ç‰ˆæœ¬å˜åŒ–ï¼š$prev_version â†’ $version" >> $GITHUB_STEP_SUMMARY
              else
                echo "  âš ï¸ ç‰ˆæœ¬æ–‡ä»¶å·²å˜åŒ–ï¼Œä½†ç‰ˆæœ¬å·æœªå˜åŒ–" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "  â­ï¸ ç‰ˆæœ¬æ–‡ä»¶æœªå˜åŒ–ï¼Œè·³è¿‡å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ **å…¶ä»–æƒ…å†µ**ï¼šéžå‘å¸ƒåˆ†æ”¯æˆ–äº‹ä»¶ï¼Œè·³è¿‡å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
          fi

          echo "should-publish=$should_publish" >> $GITHUB_OUTPUT

          # æœ€ç»ˆå†³ç­–æ‘˜è¦
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "$should_publish" == "true" ]]; then
            echo "âœ… **å‘å¸ƒå†³ç­–ï¼šç»§ç»­å‘å¸ƒ**" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **å‘å¸ƒå†³ç­–ï¼šè·³è¿‡å‘å¸ƒ**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate pre-publish report
        run: |
          echo "## ðŸš€ å‘å¸ƒå‡†å¤‡æƒ…å†µ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºéªŒè¯ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          echo "| æ ¸å¿ƒæµ‹è¯• | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** ${{ steps.version-info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**ç±»åž‹:** ${{ steps.version-info.outputs.is-snapshot == 'true' && 'å¿«ç…§ç‰ˆæœ¬' || 'æ­£å¼ç‰ˆæœ¬' }}" >> $GITHUB_STEP_SUMMARY

  # ðŸ“¦ Maven Central å‘å¸ƒ
  publish:
    name: "ðŸ“¦ Publish to Maven Central"
    needs: pre-publish-validation
    if: ${{ needs.pre-publish-validation.outputs.should-publish == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 120
    environment: maven-central

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'graalvm'
          cache: gradle

      - name: Cache Gradle wrapper
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-wrapper-

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/jdks
            ~/.gradle/buildOutputCleanup
            ~/.konan
            ~/.m2/repository
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.0.0'
          cache-cleanup: on-success

      - name: Grant execute permission
        run: chmod +x gradlew

      # è¯•è¿è¡Œæ¨¡å¼
      - name: Dry run publication
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ðŸ” æ‰§è¡Œå‘å¸ƒè¯•è¿è¡Œ..."
          ./gradlew publishToMavenLocal \
            --no-daemon \
            --parallel \
            -PsigningInMemoryKeyId="${{ secrets.GPG_KEY_ID }}" \
            -PsigningInMemoryKey="${{ secrets.GPG_PRIVATE_KEY }}" \
            -PsigningInMemoryKeyPassword="${{ secrets.GPG_PASSPHRASE }}"
        env:
          GRADLE_OPTS: "${{ env.GRADLE_OPTS }} ${{ env.JVM_OPTS }}"
          CI: true

      # å‘å¸ƒå‰éªŒè¯
      - name: Pre-publish validation
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "ðŸ” å‘å¸ƒå‰éªŒè¯..."
          
          # éªŒè¯å¿…è¦çš„å‡­æ®
          missing_secrets=()
          [[ -z "${{ secrets.GPG_KEY_ID }}" ]] && missing_secrets+=("GPG_KEY_ID")
          [[ -z "${{ secrets.GPG_PRIVATE_KEY }}" ]] && missing_secrets+=("GPG_PRIVATE_KEY")
          [[ -z "${{ secrets.MAVENCENTRAL_USERNAME }}" ]] && missing_secrets+=("MAVENCENTRAL_USERNAME")
          [[ -z "${{ secrets.MAVENCENTRAL_PASSWORD }}" ]] && missing_secrets+=("MAVENCENTRAL_PASSWORD")
          [[ -z "${{ secrets.GPG_PASSPHRASE }}" ]] && missing_secrets+=("GPG_PASSPHRASE")
          
          if [[ ${#missing_secrets[@]} -gt 0 ]]; then
            echo "âŒ ç¼ºå°‘å¿…è¦çš„ Secretsï¼š ${missing_secrets[*]}" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # éªŒè¯ç½‘ç»œè¿žæŽ¥
          echo "ðŸŒ éªŒè¯ç½‘ç»œè¿žæŽ¥..."
          curl -f -s --max-time 10 https://oss.sonatype.org/ > /dev/null || {
            echo "âš ï¸ Sonatype ç½‘ç»œè¿žæŽ¥å¼‚å¸¸" >> $GITHUB_STEP_SUMMARY
          }
          
          echo "âœ… éªŒè¯é€šè¿‡" >> $GITHUB_STEP_SUMMARY

      # æ­£å¼å‘å¸ƒï¼ˆå¢žå¼ºç‰ˆï¼‰
      - name: Publish to Maven Central
        if: github.event.inputs.dry_run != 'true'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 90
          max_attempts: 3
          retry_wait_seconds: 600
          shell: bash
          command: |
            echo "ðŸš€ å¼€å§‹å‘å¸ƒåˆ° Maven Central (attempt: ${{ github.run_attempt }})..."
            
            # è®¾ç½®é”™è¯¯å¤„ç†
            set -euo pipefail
            
            # åˆ†ç±»é”™è¯¯å¤„ç†å‡½æ•°
            handle_error() {
              local exit_code=$1
              local error_context="$2"
            
              echo "âŒ å‘å¸ƒå¤±è´¥ (é€€å‡ºç : $exit_code)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            
              case $exit_code in
                1|2) echo "**é”™è¯¯ç±»åž‹:** æž„å»ºæˆ–é…ç½®é”™è¯¯" >> $GITHUB_STEP_SUMMARY ;;
                3|4) echo "**é”™è¯¯ç±»åž‹:** GPG ç­¾åå¤±è´¥" >> $GITHUB_STEP_SUMMARY ;;
                5|6) echo "**é”™è¯¯ç±»åž‹:** Maven Central è¿žæŽ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY ;;
                *) echo "**é”™è¯¯ç±»åž‹:** æœªçŸ¥é”™è¯¯" >> $GITHUB_STEP_SUMMARY ;;
              esac
            
              echo "**é”™è¯¯ä¸Šä¸‹æ–‡:** $error_context" >> $GITHUB_STEP_SUMMARY
              exit $exit_code
            }
            
            trap 'handle_error $? "å‘å¸ƒæ‰§è¡Œé˜¶æ®µ"' ERR
            
            echo "ðŸ” éªŒè¯å‘å¸ƒå‡­æ®..." >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ å¼€å§‹å‘å¸ƒæµç¨‹..." >> $GITHUB_STEP_SUMMARY
            
            ./gradlew publishToMavenCentral \
              --no-daemon \
              --parallel \
              --no-configuration-cache \
              --stacktrace \
              --info \
              --continue \
              -PsigningInMemoryKeyId="${{ secrets.GPG_KEY_ID }}" \
              -PsigningInMemoryKey="${{ secrets.GPG_PRIVATE_KEY }}" \
              -PmavenCentralUsername="${{ secrets.MAVENCENTRAL_USERNAME }}" \
              -PmavenCentralPassword="${{ secrets.MAVENCENTRAL_PASSWORD }}" \
              -PsigningInMemoryKeyPassword="${{ secrets.GPG_PASSPHRASE }}"
            
            echo "âœ… å‘å¸ƒåˆ° Maven Central æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        env:
          GRADLE_OPTS: "${{ env.GRADLE_OPTS }} ${{ env.JVM_OPTS }}"
          MAVENCENTRAL_USERNAME: ${{ secrets.MAVENCENTRAL_USERNAME }}
          MAVENCENTRAL_PASSWORD: ${{ secrets.MAVENCENTRAL_PASSWORD }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          CI: true

      - name: Generate publication summary
        run: |
          echo "## ðŸ“¦ å‘å¸ƒå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** ${{ needs.pre-publish-validation.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**çŠ¶æ€:** ${{ github.event.inputs.dry_run == 'true' && 'è¯•è¿è¡Œå®Œæˆ ðŸ§ª' || 'æ­£å¼å‘å¸ƒå®Œæˆ ðŸš€' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ github.event.inputs.dry_run }}" != "true" ]]; then
            echo "### ðŸ“‹ å‘å¸ƒåŽæ£€æŸ¥æ¸…å•" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] éªŒè¯ Maven Central ä¸Šçš„ artifact" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] æ›´æ–°é¡¹ç›®æ–‡æ¡£" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] å‘å¸ƒ GitHub Release è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
            echo "- [ ] é€šçŸ¥å›¢é˜Ÿæˆå‘˜" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Maven Central é“¾æŽ¥:** https://search.maven.org/search?q=g:io.github.truenine" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… è¯•è¿è¡ŒæˆåŠŸï¼Œæ‰€æœ‰æ¨¡å—éƒ½å·²æ­£ç¡®æž„å»ºå’Œç­¾åï¼" >> $GITHUB_STEP_SUMMARY
          fi

  # ðŸ·ï¸ GitHub Release åˆ›å»º
  create-github-release:
    name: "ðŸ·ï¸ Create GitHub Release"
    needs: [ pre-publish-validation, publish ]
    if: github.event.inputs.dry_run != 'true' && needs.pre-publish-validation.outputs.is-snapshot == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: release-notes
        run: |
          version="${{ needs.pre-publish-validation.outputs.version }}"

          # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
          cat > release_notes.md << 'EOF'
          ## ðŸš€ Release ${{ needs.pre-publish-validation.outputs.version }}

          ### ðŸ“¦ Maven Central Artifacts

          This release is available on Maven Central Repository:
          
          ```kotlin
          implementation("io.github.truenine:composeserver-{module-name}:${{ needs.pre-publish-validation.outputs.version }}")
          ```

          ```xml
          <dependency>
            <groupId>io.github.truenine</groupId>
            <artifactId>composeserver-{module-name}</artifactId>
            <version>${{ needs.pre-publish-validation.outputs.version }}</version>
          </dependency>
          ```

          ### ðŸ”— Links

          - [Maven Central Search](https://search.maven.org/search?q=g:io.github.truenine%20AND%20v:${{ needs.pre-publish-validation.outputs.version }})
          - [Project Documentation](https://github.com/TrueNine/compose-server)
          - [API Documentation](https://github.com/TrueNine/compose-server/tree/main/docs)

          ---

          **Full Changelog**: https://github.com/TrueNine/compose-server/compare/v${{ needs.pre-publish-validation.outputs.version }}...HEAD
          EOF

          echo "Generated release notes for version $version"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.pre-publish-validation.outputs.version }}
          name: ${{ needs.pre-publish-validation.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release summary
        run: |
          echo "## ðŸ·ï¸ GitHub Release åˆ›å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬æ ‡ç­¾:** v${{ needs.pre-publish-validation.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release é“¾æŽ¥:** https://github.com/TrueNine/compose-server/releases/tag/v${{ needs.pre-publish-validation.outputs.version }}" >> $GITHUB_STEP_SUMMARY

  # ðŸ“‹ å‘å¸ƒåŽéªŒè¯
  post-publish-verification:
    name: "ðŸ“‹ Post-publish Verification"
    needs: [ pre-publish-validation, publish, create-github-release ]
    if: github.event.inputs.dry_run != 'true' && always() && needs.publish.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Wait for Maven Central sync
        run: |
          echo "â³ ç­‰å¾… Maven Central åŒæ­¥..."
          sleep 300  # ç­‰å¾… 5 åˆ†é’Ÿ

      - name: Verify publication
        run: |
          version="${{ needs.pre-publish-validation.outputs.version }}"
          group="io.github.truenine"
          
          echo "ðŸ” éªŒè¯å‘å¸ƒçš„ artifacts..."
          
          # æ£€æŸ¥ä¸»è¦æ¨¡å—æ˜¯å¦å¯ç”¨
          modules=("shared" "gradle-plugin" "bom")
          
          for module in "${modules[@]}"; do
            artifact="${group}:composeserver-${module}:${version}"
            echo "æ£€æŸ¥ $artifact ..."
          
            # å°è¯•ä»Ž Maven Central èŽ·å– metadata
            url="https://search.maven.org/solrsearch/select?q=g:${group}+AND+a:composeserver-${module}+AND+v:${version}&rows=1&wt=json"
          
            response=$(curl -s "$url" || echo '{"response":{"numFound":0}}')
            found=$(echo "$response" | jq -r '.response.numFound')
          
            if [[ "$found" -gt 0 ]]; then
              echo "âœ… $artifact å·²æˆåŠŸå‘å¸ƒ"
            else
              echo "âš ï¸ $artifact å°šæœªåœ¨ Maven Central ä¸Šå¯è§ï¼ˆå¯èƒ½ä»åœ¨åŒæ­¥ä¸­ï¼‰"
            fi
          done

      - name: Generate verification report
        run: |
          echo "## ðŸ” å‘å¸ƒéªŒè¯æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** ${{ needs.pre-publish-validation.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š éªŒè¯çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- â³ Maven Central åŒæ­¥å¯èƒ½éœ€è¦å‡ å°æ—¶" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” å»ºè®®åœ¨ 4-6 å°æ—¶åŽå†æ¬¡éªŒè¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ç›¸å…³é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Maven Central æœç´¢](https://search.maven.org/search?q=g:io.github.truenine)" >> $GITHUB_STEP_SUMMARY
          echo "- [Sonatype Repository](https://oss.sonatype.org/)" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥ GitHub Release çŠ¶æ€
          if [[ "${{ needs.create-github-release.result }}" == "success" ]]; then
            echo "- [GitHub Release](https://github.com/TrueNine/compose-server/releases/tag/v${{ needs.pre-publish-validation.outputs.version }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **GitHub Release åˆ›å»ºæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.create-github-release.result }}" == "skipped" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ **GitHub Release å·²è·³è¿‡**ï¼ˆé¢„å‘å¸ƒç‰ˆæœ¬ï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **GitHub Release åˆ›å»ºå¤±è´¥**ï¼Œè¯·æ‰‹åŠ¨åˆ›å»º" >> $GITHUB_STEP_SUMMARY
          fi

  # ðŸš¨ å¤±è´¥å¤„ç†
  failure-handler:
    name: "ðŸš¨ Handle Failure"
    needs: [ pre-publish-validation, publish, create-github-release, post-publish-verification ]
    if: always() && (needs.publish.result == 'failure' || needs.create-github-release.result == 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Generate failure report
        run: |
          echo "## âŒ å‘å¸ƒå¤±è´¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** ${{ needs.pre-publish-validation.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘äº‹ä»¶:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**å¤±è´¥æ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ” å¤±è´¥çŠ¶æ€åˆ†æž" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.publish.result }}" == "failure" ]]; then
            echo "- âŒ **Maven Central å‘å¸ƒå¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            echo "  - æ£€æŸ¥ GPG ç­¾åé…ç½®" >> $GITHUB_STEP_SUMMARY
            echo "  - éªŒè¯ Maven Central å‡­æ®" >> $GITHUB_STEP_SUMMARY
            echo "  - ç¡®è®¤ç½‘ç»œè¿žæŽ¥æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… Maven Central å‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.create-github-release.result }}" == "failure" ]]; then
            echo "- âŒ **GitHub Release åˆ›å»ºå¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            echo "  - æ£€æŸ¥ GITHUB_TOKEN æƒé™" >> $GITHUB_STEP_SUMMARY
            echo "  - éªŒè¯æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
            echo "  - ç¡®è®¤ä»“åº“å†™å…¥æƒé™" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.create-github-release.result }}" == "success" ]]; then
            echo "- âœ… GitHub Release åˆ›å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ› ï¸ å»ºè®®çš„ä¿®å¤æ­¥éª¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. æ£€æŸ¥ä¸Šè¿°å¤±è´¥çš„ç»„ä»¶é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "2. éªŒè¯æ‰€æœ‰å¿…è¦çš„ GitHub Secrets æ˜¯å¦æ­£ç¡®é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "3. å¦‚æžœæ˜¯ç½‘ç»œé—®é¢˜ï¼Œå¯ä»¥é‡æ–°è¿è¡Œå·¥ä½œæµ" >> $GITHUB_STEP_SUMMARY
          echo "4. å¦‚æžœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·åˆ›å»º Issue æŠ¥å‘Šé—®é¢˜" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ž èŽ·å–å¸®åŠ©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [åˆ›å»º Issue](https://github.com/TrueNine/compose-server/issues/new)" >> $GITHUB_STEP_SUMMARY
          echo "- [æŸ¥çœ‹æ–‡æ¡£](https://github.com/TrueNine/compose-server/tree/main/docs)" >> $GITHUB_STEP_SUMMARY

  # ðŸ“Š å·¥ä½œæµæ‘˜è¦
  workflow-summary:
    name: "ðŸ“Š Workflow Summary"
    needs: [ pre-publish-validation, publish, create-github-release, post-publish-verification, failure-handler ]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Generate workflow summary
        run: |
          echo "# ðŸš€ Maven Central å‘å¸ƒå·¥ä½œæµæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å·¥ä½œæµè¿è¡Œæ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘äº‹ä»¶:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**åˆ†æ”¯/æ ‡ç­¾:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**æäº¤ SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ä»»åŠ¡çŠ¶æ€æ‘˜è¦
          echo "## ðŸ“‹ ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ä»»åŠ¡ | çŠ¶æ€ | ç»“æžœ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª å‘å¸ƒå‰éªŒè¯ | ${{ needs.pre-publish-validation.result }} | ${{ needs.pre-publish-validation.result == 'success' && 'âœ…' || needs.pre-publish-validation.result == 'failure' && 'âŒ' || needs.pre-publish-validation.result == 'skipped' && 'â­ï¸' || 'ðŸ”„' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Maven Central å‘å¸ƒ | ${{ needs.publish.result }} | ${{ needs.publish.result == 'success' && 'âœ…' || needs.publish.result == 'failure' && 'âŒ' || needs.publish.result == 'skipped' && 'â­ï¸' || 'ðŸ”„' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ·ï¸ GitHub Release | ${{ needs.create-github-release.result }} | ${{ needs.create-github-release.result == 'success' && 'âœ…' || needs.create-github-release.result == 'failure' && 'âŒ' || needs.create-github-release.result == 'skipped' && 'â­ï¸' || 'ðŸ”„' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‹ å‘å¸ƒåŽéªŒè¯ | ${{ needs.post-publish-verification.result }} | ${{ needs.post-publish-verification.result == 'success' && 'âœ…' || needs.post-publish-verification.result == 'failure' && 'âŒ' || needs.post-publish-verification.result == 'skipped' && 'â­ï¸' || 'ðŸ”„' }} |" >> $GITHUB_STEP_SUMMARY

          # ç‰ˆæœ¬ä¿¡æ¯
          if [[ "${{ needs.pre-publish-validation.outputs.version }}" != "" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ“¦ ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ç‰ˆæœ¬å·:** ${{ needs.pre-publish-validation.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "**ç‰ˆæœ¬ç±»åž‹:** ${{ needs.pre-publish-validation.outputs.is-snapshot == 'true' && 'é¢„å‘å¸ƒç‰ˆæœ¬' || 'æ­£å¼ç‰ˆæœ¬' }}" >> $GITHUB_STEP_SUMMARY
            echo "**å‘å¸ƒçŠ¶æ€:** ${{ needs.pre-publish-validation.outputs.should-publish == 'true' && 'å·²å‘å¸ƒ' || 'å·²è·³è¿‡' }}" >> $GITHUB_STEP_SUMMARY
          fi

          # æ€»ä½“çŠ¶æ€
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ æ€»ä½“çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.publish.result }}" == "success" ]]; then
            echo "ðŸŽ‰ **å‘å¸ƒæˆåŠŸï¼** æ–°ç‰ˆæœ¬å·²æˆåŠŸå‘å¸ƒåˆ° Maven Central" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.publish.result }}" == "skipped" ]]; then
            echo "â­ï¸ **å‘å¸ƒå·²è·³è¿‡** - æ— ç‰ˆæœ¬å˜åŒ–æˆ–ä¸º PR éªŒè¯" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.publish.result }}" == "failure" ]]; then
            echo "âŒ **å‘å¸ƒå¤±è´¥** - è¯·æŸ¥çœ‹é”™è¯¯æ—¥å¿—å¹¶é‡è¯•" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ”„ **å·¥ä½œæµè¿›è¡Œä¸­** - è¯·ç­‰å¾…å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          fi
