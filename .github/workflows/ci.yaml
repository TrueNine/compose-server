name: CI

on:
  push:
    branches: [ main, dev ]
    paths:
      - '.github/workflows/ci.yaml'
      - '**/*.kt'
      - '**/*.kts'
      - 'gradle/libs.versions.toml'
      - '**/build.gradle.kts'
      - 'gradle.properties'
      - 'settings.gradle.kts'
  pull_request:
    branches: [ main, dev ]
    paths:
      - '.github/workflows/ci.yaml'
      - '**/*.kt'
      - '**/*.kts'
      - 'gradle/libs.versions.toml'
      - '**/build.gradle.kts'
      - 'gradle.properties'
      - 'settings.gradle.kts'

# Èò≤Ê≠¢Âêå‰∏ÄÂàÜÊîØÁöÑÂ§öÊ¨°Âπ∂ÂèëÊâßË°å
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # üöÄ ‰ºòÂåñÂêéÁöÑ Gradle ÈÖçÁΩÆ - ÊèêÂçáÊûÑÂª∫ÊÄßËÉΩ
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=6 -Dkotlin.incremental=true -Dorg.gradle.configuration-cache=true -Dorg.gradle.build-cache=true -Dorg.gradle.caching=true"
  # üéØ JVM ÊÄßËÉΩ‰ºòÂåñÈÖçÁΩÆ - ÈíàÂØπ GitHub Actions ÁéØÂ¢ÉË∞É‰ºò
  JVM_OPTS: "-Xmx4g -XX:MaxMetaspaceSize=1g -XX:+UseG1GC -XX:G1HeapRegionSize=16m -XX:+UseStringDeduplication"
  # üê≥ Docker Âíå TestContainers ‰ºòÂåñ
  TESTCONTAINERS_RYUK_DISABLED: false
  TESTCONTAINERS_REUSE_ENABLE: true
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  # üîß CI ÁéØÂ¢ÉÊ†áËØÜ
  CI: true

jobs:
  # üîç Âø´ÈÄüÊ£ÄÊü• - ÁºñËØëÂíåÂü∫Á°ÄÈ™åËØÅ
  quick-check:
    name: "üîç Quick Check"
    runs-on: ubuntu-latest
    timeout-minutes: 8
    outputs:
      cache-key: ${{ steps.cache-info.outputs.cache-key }}
      gradle-cache-key: ${{ steps.cache-info.outputs.gradle-cache-key }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # ÊµÖÂÖãÈöÜÊèêÂçáÈÄüÂ∫¶

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'graalvm'
          cache: gradle

      - name: üìä Cache info
        id: cache-info
        run: |
          # ÁîüÊàêÊõ¥Á≤æÁ°ÆÁöÑÁºìÂ≠òÈîÆ
          GRADLE_CACHE_KEY="${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml', 'build-logic/**/*') }}"
          DEPS_CACHE_KEY="${{ runner.os }}-deps-${{ hashFiles('gradle/libs.versions.toml', '**/build.gradle.kts') }}"
          echo "cache-key=$GRADLE_CACHE_KEY" >> $GITHUB_OUTPUT
          echo "gradle-cache-key=$DEPS_CACHE_KEY" >> $GITHUB_OUTPUT

      - name: üéØ Cache Gradle wrapper and distributions
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
            ~/.gradle/caches/jars-*
            ~/.gradle/caches/modules-*
          key: ${{ steps.cache-info.outputs.gradle-cache-key }}
          restore-keys: |
            ${{ runner.os }}-deps-
            ${{ runner.os }}-gradle-

      - name: üì¶ Cache build outputs
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches/build-cache-*
            ~/.gradle/buildOutputCleanup
            **/build/classes
            **/build/generated
          key: ${{ steps.cache-info.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.0.0'
          cache-read-only: false
          cache-write-only: false

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: üöÄ Quick compile with optimizations
        run: |
          # È¢ÑÁÉ≠ Gradle daemon Âπ∂ÁºñËØë
          ./gradlew help --quiet
          ./gradlew compileKotlin compileTestKotlin \
            --no-daemon \
            --parallel \
            --build-cache \
            --configuration-cache \
            --quiet

  # üß™ ‰ºòÂåñÂêéÁöÑÂπ∂Ë°åÊµãËØïÁü©Èòµ - Âü∫‰∫éÂÆûÈôÖÊ®°ÂùóÁªìÊûÑÈáçÊñ∞ÂàÜÁªÑ
  test-matrix:
    name: "üß™ Test"
    needs: quick-check
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      max-parallel: 8  # ÊèêÈ´òÂπ∂Ë°åÂ∫¶‰ª•ÂÖÖÂàÜÂà©Áî®ËµÑÊ∫ê
      matrix:
        group:
          - "core-foundation"    # Ê†∏ÂøÉÂü∫Á°ÄÊ®°Âùó
          - "build-tooling"      # ÊûÑÂª∫Â∑•ÂÖ∑ÈìæÊ®°Âùó
          - "rds-core"           # Êï∞ÊçÆÂ∫ìÊ†∏ÂøÉÊ®°Âùó
          - "rds-integrations"   # Êï∞ÊçÆÂ∫ìÈõÜÊàêÊ®°Âùó
          - "oss-services"       # ÂØπË±°Â≠òÂÇ®ÊúçÂä°
          - "ai-pay-services"    # AI ÂíåÊîØ‰ªòÊúçÂä°
          - "messaging-sms"      # Ê∂àÊÅØÂíåÁü≠‰ø°ÊúçÂä°
          - "security-crypto"    # ÂÆâÂÖ®ÂíåÂä†ÂØÜÊ®°Âùó
          - "data-processing"    # Êï∞ÊçÆÂ§ÑÁêÜÊ®°Âùó
          - "platform-sdk"       # Âπ≥Âè∞ SDK ÂíåÂ∑•ÂÖ∑
          - "integration-tests"  # ÈõÜÊàêÊµãËØïÊ®°Âùó
        include:
          - group: "core-foundation"
            modules: "shared testtoolkit:testtoolkit-shared testtoolkit:testtoolkit-springmvc cacheable"
            containers: "redis"
            timeout: 12
          - group: "build-tooling"
            modules: "gradle-plugin version-catalog bom docsite"
            containers: "none"
            timeout: 8
          - group: "rds-core"
            modules: "rds:rds-shared rds:rds-flyway-migration-shared"
            containers: "none"
            timeout: 6
          - group: "rds-integrations"
            modules: "rds:rds-crud rds:rds-jimmer-ext-postgres rds:rds-flyway-migration-postgresql rds:rds-flyway-migration-mysql8 testtoolkit:testtoolkit-testcontainers"
            containers: "database"
            timeout: 25
          - group: "oss-services"
            modules: "oss:oss-shared oss:oss-minio oss:oss-aliyun-oss oss:oss-huawei-obs oss:oss-volcengine-tos"
            containers: "oss"
            timeout: 18
          - group: "ai-pay-services"
            modules: "ai:ai-shared ai:ai-langchain4j pay:pay-shared pay:pay-wechat"
            containers: "redis"
            timeout: 15
          - group: "messaging-sms"
            modules: "sms:sms-shared sms:sms-tencent surveillance:surveillance-shared surveillance:surveillance-hikvision"
            containers: "redis"
            timeout: 12
          - group: "security-crypto"
            modules: "security:security-crypto security:security-oauth2 security:security-spring"
            containers: "none"
            timeout: 10
          - group: "data-processing"
            modules: "data:data-crawler data:data-extract ksp:ksp-meta ksp:ksp-plugin ksp:ksp-shared"
            containers: "none"
            timeout: 12
          - group: "platform-sdk"
            modules: "psdk:psdk-wxpa depend:depend-http-exchange depend:depend-jackson depend:depend-paho depend:depend-servlet depend:depend-springdoc-openapi depend:depend-xxl-job ide:ide-idea-mcp"
            containers: "none"
            timeout: 15
          - group: "integration-tests"
            modules: "integrate-test:depend:jackson integrate-test:oss:minio"
            containers: "full"
            timeout: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # ÊµÖÂÖãÈöÜ

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'graalvm'
          cache: gradle

      - name: üéØ Restore Gradle wrapper cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.gradle/wrapper
            ~/.gradle/caches/jars-*
            ~/.gradle/caches/modules-*
          key: ${{ needs.quick-check.outputs.gradle-cache-key }}
          restore-keys: |
            ${{ runner.os }}-deps-
            ${{ runner.os }}-gradle-

      - name: üì¶ Restore build cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.gradle/caches/build-cache-*
            ~/.gradle/buildOutputCleanup
            **/build/classes
            **/build/generated
          key: ${{ needs.quick-check.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.0.0'
          cache-read-only: true
          cache-write-only: false

      # üê≥ ‰ºòÂåñÁöÑ Docker ËÆæÁΩÆ
      - name: Set up Docker Buildx
        if: matrix.containers != 'none'
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:v0.12.0

      - name: üóÇÔ∏è Cache Docker layers
        if: matrix.containers != 'none'
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-docker-${{ matrix.group }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-docker-${{ matrix.group }}-
            ${{ runner.os }}-docker-

      # üê≥ È¢ÑÊãâÂèñÂÆπÂô®ÈïúÂÉè - Ê†πÊçÆÊµãËØïÈúÄÊ±Ç‰ºòÂåñ
      - name: Pre-pull Redis images
        if: matrix.containers == 'redis'
        run: |
          echo "üì¶ ÊãâÂèñ Redis ÈïúÂÉè..."
          docker pull redis:7-alpine
          echo "‚úÖ Redis ÈïúÂÉèÊãâÂèñÂÆåÊàê"
        continue-on-error: true

      - name: Pre-pull database images
        if: matrix.containers == 'database'
        run: |
          echo "üêò ÊãâÂèñÊï∞ÊçÆÂ∫ìÈïúÂÉè..."
          docker pull postgres:16-alpine &
          docker pull mysql:8.0 &
          docker pull redis:7-alpine &
          wait
          echo "‚úÖ Êï∞ÊçÆÂ∫ìÈïúÂÉèÊãâÂèñÂÆåÊàê"
        continue-on-error: true

      - name: Pre-pull OSS images
        if: matrix.containers == 'oss'
        run: |
          echo "üì¶ ÊãâÂèñÂØπË±°Â≠òÂÇ®ÈïúÂÉè..."
          docker pull redis:7-alpine &
          docker pull minio/minio:RELEASE.2024-01-16T16-07-38Z &
          wait
          echo "‚úÖ ÂØπË±°Â≠òÂÇ®ÈïúÂÉèÊãâÂèñÂÆåÊàê"
        continue-on-error: true

      - name: Pre-pull all required images
        if: matrix.containers == 'full'
        run: |
          echo "üöÄ ÊãâÂèñÂÖ®ÈáèÊµãËØïÈïúÂÉè..."
          docker pull postgres:16-alpine &
          docker pull mysql:8.0 &
          docker pull redis:7-alpine &
          docker pull minio/minio:RELEASE.2024-01-16T16-07-38Z &
          wait
          echo "‚úÖ ÂÖ®ÈáèÊµãËØïÈïúÂÉèÊãâÂèñÂÆåÊàê"
        continue-on-error: true

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: üß™ Run tests for ${{ matrix.group }} modules
        timeout-minutes: ${{ matrix.timeout }}
        run: |
          echo "üöÄ ÂºÄÂßãÊâßË°å ${{ matrix.group }} Ê®°ÂùóÁªÑÊµãËØï..."
          echo "üìö Ê®°ÂùóÂàóË°®Ôºö ${{ matrix.modules }}"
          echo "üê≥ ÂÆπÂô®ÈÖçÁΩÆÔºö ${{ matrix.containers }}"
          echo "‚è±Ô∏è Ë∂ÖÊó∂ËÆæÁΩÆÔºö ${{ matrix.timeout }} ÂàÜÈíü"

          # ËÆæÁΩÆÈîôËØØÂ§ÑÁêÜ
          set -e
          trap 'echo "‚ùå ÊµãËØïÊâßË°åÂ§±Ë¥•ÔºåÊ≠£Âú®Êî∂ÈõÜÈîôËØØ‰ø°ÊÅØ..." >> $GITHUB_STEP_SUMMARY' ERR

          # È¢ÑÁÉ≠ Gradle
          ./gradlew help --quiet

          # Â∞ÜÊ®°ÂùóÂêçËΩ¨Êç¢‰∏∫ÊµãËØï‰ªªÂä°
          modules="${{ matrix.modules }}"
          test_tasks=""
          for module in $modules; do
            if [[ "$module" == *":"* ]]; then
              # Â≠êÊ®°ÂùóÊ†ºÂºè (Â¶Ç rds:rds-shared)
              test_tasks="$test_tasks :$module:test"
            else
              # Ê†πÁ∫ßÊ®°ÂùóÊ†ºÂºè (Â¶Ç shared)
              test_tasks="$test_tasks :$module:test"
            fi
          done

          echo "üéØ ÊâßË°åÊµãËØï‰ªªÂä°: $test_tasks"
          ./gradlew $test_tasks \
            --no-daemon \
            --parallel \
            --build-cache \
            --configuration-cache \
            --continue \
            --quiet \
            -Dorg.gradle.workers.max=4 \
            -Dorg.gradle.jvmargs="-Xmx3g -XX:MaxMetaspaceSize=768m"
        env:
          # üê≥ TestContainers ‰ºòÂåñÈÖçÁΩÆ
          TESTCONTAINERS_RYUK_DISABLED: false
          TESTCONTAINERS_CHECKS_DISABLE: false
          TESTCONTAINERS_REUSE_ENABLE: true
          TESTCONTAINERS_HUB_IMAGE_NAME_PREFIX: ""
          TESTCONTAINERS_REUSE_HASH_LABELS: true
          # ‚è±Ô∏è TestContainers Ë∂ÖÊó∂ÂíåÂêØÂä®ÈÖçÁΩÆ - ‰ºòÂåñÂêØÂä®Êó∂Èó¥
          TESTCONTAINERS_PULL_PAUSE_TIMEOUT: 20
          TESTCONTAINERS_STARTUP_TIMEOUT: 90
          TESTCONTAINERS_CONNECT_TIMEOUT: 30
          # üöÄ Docker ÊÄßËÉΩ‰ºòÂåñ
          DOCKER_HOST: unix:///var/run/docker.sock
          TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE: /var/run/docker.sock
          TESTCONTAINERS_HOST_OVERRIDE: localhost
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain
          # üéØ JVM ÊÄßËÉΩË∞É‰ºò - ÈíàÂØπÊµãËØïÁéØÂ¢É‰ºòÂåñ
          GRADLE_OPTS: "${{ env.GRADLE_OPTS }}"
          JAVA_OPTS: "${{ env.JVM_OPTS }}"
          # üîß CI ÁéØÂ¢ÉÈÖçÁΩÆ
          CI: true
          GRADLE_BUILD_ACTION_CACHE_DEBUG_ENABLED: false
          # üìä ÊµãËØïÂπ∂Ë°åÈÖçÁΩÆ
          JUNIT_PLATFORM_EXECUTION_PARALLEL_ENABLED: true
          JUNIT_PLATFORM_EXECUTION_PARALLEL_MODE_DEFAULT: concurrent

      - name: Collect test diagnostics
        if: failure()
        run: |
          echo "üîç Êî∂ÈõÜÊµãËØïËØäÊñ≠‰ø°ÊÅØ..."
          
          # Êî∂ÈõÜ Gradle ÊûÑÂª∫Êó•Âøó
          find . -name "*.log" -type f -exec echo "=== {} ===" \; -exec cat {} \; || true
          
          # Êî∂ÈõÜÂÆπÂô®Êó•Âøó
          if [[ "${{ matrix.containers }}" != "none" ]]; then
            echo "üê≥ Êî∂ÈõÜÂÆπÂô®Êó•Âøó..."
            docker ps -a || true
            docker logs $(docker ps -aq --filter "label=org.testcontainers=true") || true
          fi
          
          # JVM Â†ÜËΩ¨ÂÇ®ÂíåÁ∫øÁ®ã‰ø°ÊÅØ
          if pgrep -f "org.gradle.launcher.daemon.bootstrap.GradleDaemon" > /dev/null; then
            echo "üëç Êî∂ÈõÜ JVM ËØäÊñ≠‰ø°ÊÅØ..."
            jps -v || true
          fi
          
          # Á≥ªÁªüËµÑÊ∫ê‰ΩøÁî®
          echo "üìà Á≥ªÁªüËµÑÊ∫ê‰ΩøÁî®Ôºö"
          free -h || true
          df -h || true

      - name: Upload test results and diagnostics
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.group }}
          path: |
            **/build/reports/tests/
            **/build/test-results/
            **/build/tmp/test/
            **/*.log
          retention-days: 5

      - name: üßº Êô∫ËÉΩÊ∏ÖÁêÜÂÆπÂô®ËµÑÊ∫ê
        if: always() && matrix.containers != 'none'
        run: |
          echo "üßº ÂºÄÂßãÊô∫ËÉΩÊ∏ÖÁêÜ Docker ËµÑÊ∫ê..."

          # ÊòæÁ§∫ÂΩìÂâçËµÑÊ∫ê‰ΩøÁî®ÊÉÖÂÜµ
          echo "üìà Ê∏ÖÁêÜÂâç Docker ËµÑÊ∫ê‰ΩøÁî®ÊÉÖÂÜµÔºö"
          docker system df || true
          
          # ÂÅúÊ≠¢Âπ∂Âà†Èô§ÊµãËØïÂÆπÂô®Ôºà‰ΩÜ‰øùÁïôÈáçÁî®ÂÆπÂô®Ôºâ
          echo "üõë ÂÅúÊ≠¢ÊµãËØïÂÆπÂô®..."
          docker ps -q --filter "label=org.testcontainers=true" --filter "label!=org.testcontainers.reuse.enable=true" | xargs -r docker stop || true
          
          echo "üóëÔ∏è Âà†Èô§ÊµãËØïÂÆπÂô®Ôºà‰øùÁïôÈáçÁî®ÂÆπÂô®Ôºâ..."
          docker container prune -f --filter "label=org.testcontainers=true" --filter "label!=org.testcontainers.reuse.enable=true" || true
          
          # Ê∏ÖÁêÜÊÇ¨Á©∫ÂíåÊú™‰ΩøÁî®ÁöÑÈïúÂÉèÔºå‰ΩÜ‰øùÁïôÂü∫Á°ÄÈïúÂÉè
          echo "üñºÔ∏è Ê∏ÖÁêÜÊÇ¨Á©∫ÈïúÂÉè..."
          docker image prune -f --filter "dangling=true" || true
          
          # Ê∏ÖÁêÜÊú™‰ΩøÁî®ÁöÑÁΩëÁªúÔºà‰ΩÜ‰øùÁïô default ÁΩëÁªúÔºâ
          echo "üåê Ê∏ÖÁêÜÊµãËØïÁΩëÁªú..."
          docker network prune -f --filter "until=1h" || true
          
          # Ê∏ÖÁêÜÊú™‰ΩøÁî®ÁöÑÂç∑Ôºà‰ΩÜ‰øùÁïôÈáçÁî®Âç∑Ôºâ
          echo "üíæ Ê∏ÖÁêÜ‰∏¥Êó∂Âç∑..."
          docker volume prune -f --filter "label!=org.testcontainers.reuse.enable=true" || true

          # ÊòæÁ§∫Ê∏ÖÁêÜÂêéÁöÑËµÑÊ∫êÊÉÖÂÜµ
          echo "‚ú® Ê∏ÖÁêÜÂêé Docker ËµÑÊ∫ê‰ΩøÁî®ÊÉÖÂÜµÔºö"
          docker system df || true
          
          echo "üèÅ Docker ËµÑÊ∫êÊ∏ÖÁêÜÂÆåÊàê"

  # üìä ÊµãËØïÁªìÊûúÊ±áÊÄª
  test-results:
    name: "üìä Test Results Summary"
    needs: [ quick-check, test-matrix ]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
          pattern: test-results-*

      - name: Generate comprehensive test summary
        run: |
          echo "# üß™ ÊµãËØïÁªìÊûúËØ¶ÁªÜÊä•Âëä" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ÊâßË°åÊó∂Èó¥:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ÊµãËØïÁéØÂ¢É:** GitHub Actions (ubuntu-latest)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## üìà Ê®°ÂùóÁªÑÊµãËØïÁä∂ÊÄÅ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ê®°ÂùóÁªÑ | Áä∂ÊÄÅ | ÂÆπÂô®‰æùËµñ | ËÄóÊó∂ |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|----------|------|" >> $GITHUB_STEP_SUMMARY
          
          # Ê®°ÂùóÁªÑ‰ø°ÊÅØ - Êõ¥Êñ∞‰∏∫Êñ∞ÁöÑÂàÜÁªÑ
          declare -A group_containers=(
            ["core-foundation"]="Redis"
            ["build-tooling"]="Êó†"
            ["rds-core"]="Êó†"
            ["rds-integrations"]="PostgreSQL, MySQL, Redis"
            ["oss-services"]="Redis, MinIO"
            ["ai-pay-services"]="Redis"
            ["messaging-sms"]="Redis"
            ["security-crypto"]="Êó†"
            ["data-processing"]="Êó†"
            ["platform-sdk"]="Êó†"
            ["integration-tests"]="ÂÖ®ÈáèÂÆπÂô®"
          )

          for group in core-foundation build-tooling rds-core rds-integrations oss-services ai-pay-services messaging-sms security-crypto data-processing platform-sdk integration-tests; do
            containers="${group_containers[$group]}"
            if [[ "${{ needs.test-matrix.result }}" == "success" ]]; then
              echo "| $group | ‚úÖ ÈÄöËøá | $containers | - |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $group | ‚ùå Â§±Ë¥• | $containers | - |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Ê∑ªÂä†Â§±Ë¥•ÂàÜÊûê
          if [[ "${{ needs.test-matrix.result }}" != "success" ]]; then
            echo "## ‚ùå Â§±Ë¥•ÂàÜÊûêÂíåÂª∫ËÆÆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üîç **Â∏∏ËßÅÈóÆÈ¢òÊéíÊü•:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. **TestContainers ÂêØÂä®Â§±Ë¥•**" >> $GITHUB_STEP_SUMMARY
            echo "   - Ê£ÄÊü• Docker ÊúçÂä°ÊòØÂê¶Ê≠£Â∏∏" >> $GITHUB_STEP_SUMMARY
            echo "   - Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂíåÈïúÂÉèÊãâÂèñ" >> $GITHUB_STEP_SUMMARY
            echo "   - Ë∂ÖÊó∂ÈÖçÁΩÆÂèØËÉΩÈúÄË¶ÅË∞ÉÊï¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "2. **ÂÜÖÂ≠ò‰∏çË∂≥ (OOM)**" >> $GITHUB_STEP_SUMMARY
            echo "   - JVM Â†ÜÂÜÖÂ≠òËÆæÁΩÆÔºö4GB" >> $GITHUB_STEP_SUMMARY
            echo "   - Metaspace ËÆæÁΩÆÔºö1.5GB" >> $GITHUB_STEP_SUMMARY
            echo "   - Âπ∂Ë°å worker ÈôêÂà∂Ôºö6‰∏™" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "3. **ÊµãËØï‰æùËµñÂÜ≤Á™Å**" >> $GITHUB_STEP_SUMMARY
            echo "   - Ê£ÄÊü•Âπ∂Ë°åÊµãËØï‰∏≠ÁöÑÁ´ØÂè£ÂÜ≤Á™Å" >> $GITHUB_STEP_SUMMARY
            echo "   - È™åËØÅÊï∞ÊçÆÂ∫ìËøûÊé•Ê±†ÈÖçÁΩÆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check overall status
        run: |
          if [[ "${{ needs.quick-check.result }}" != "success" ]]; then
            echo "‚ùå Quick check failed"
            exit 1
          fi
          if [[ "${{ needs.test-matrix.result }}" != "success" ]]; then
            echo "‚ùå Test matrix failed" 
            exit 1
          fi
          echo "‚úÖ All checks passed"
