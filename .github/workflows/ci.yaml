name: CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev  ]

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4 -Dkotlin.incremental=false"

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.konan
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.0.0-rc-3'
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
          cache-cleanup: on-success

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-docker-${{ hashFiles('**/Dockerfile*', '**/docker-compose*') }}
          restore-keys: |
            ${{ runner.os }}-docker-

      - name: Verify Docker installation
        run: |
          docker --version
          docker info
          docker ps

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Warm up Gradle daemon
        run: ./gradlew --version

      - name: Pre-pull common Docker images for Testcontainers
        run: |
          # 预拉取常用的测试镜像，提高 Testcontainers 启动速度
          docker pull postgres:15-alpine || true
          docker pull redis:7-alpine || true
          docker pull mysql:8.0 || true
          docker pull mongo:7 || true
          docker pull nginx:alpine || true
          # 可以根据你的项目需要调整镜像列表

      - name: Run tests
        run: ./gradlew clean test --no-daemon --stacktrace --parallel --build-cache --configuration-cache
        env:
          # Testcontainers 优化配置
          TESTCONTAINERS_RYUK_DISABLED: false
          TESTCONTAINERS_CHECKS_DISABLE: false
          TESTCONTAINERS_REUSE_ENABLE: true
          TESTCONTAINERS_HUB_IMAGE_NAME_PREFIX: ""
          # 启用容器重用标签，提高缓存效率
          TESTCONTAINERS_REUSE_HASH_LABELS: true
          # Docker 性能优化
          DOCKER_HOST: unix:///var/run/docker.sock
          TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE: /var/run/docker.sock
          TESTCONTAINERS_HOST_OVERRIDE: localhost
          # Docker 镜像缓存优化
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain
          # JVM 性能调优
          MAVEN_OPTS: "-Xmx2g -XX:+UseG1GC"
          # CI 环境配置
          CI: true
          GRADLE_BUILD_ACTION_CACHE_DEBUG_ENABLED: true

      - name: Cleanup Docker containers
        if: always()
        run: |
          # 清理停止的容器，但保留可重用的容器
          docker container prune -f --filter "until=1h" --filter "label!=org.testcontainers.reuse.enable=true"
          # 保留常用镜像，只清理较老的镜像
          docker image prune -f --filter "until=48h" --filter "dangling=true"
          # 清理未使用的卷，但保留标记为保留的卷
          docker volume prune -f --filter "label!=keep" --filter "label!=org.testcontainers"

      - name: Cache cleanup
        if: always()
        run: |
          # 清理旧的 Gradle 缓存文件
          find ~/.gradle/caches -name "*.lock" -delete || true
          find ~/.gradle/caches -type d -name "tmp" -exec rm -rf {} + || true
