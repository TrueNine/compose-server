name: CI

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4 -Dkotlin.incremental=false -Dorg.gradle.caching=false"

jobs:
  # ğŸ³ Setup Docker & Testcontainers
  setup-docker:
    name: "ğŸ³ Setup Docker & Testcontainers"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-docker-${{ hashFiles('**/Dockerfile*', '**/docker-compose*') }}
          restore-keys: |
            ${{ runner.os }}-docker-

      - name: Verify Docker installation
        run: |
          docker --version
          docker info
          docker ps

      - name: Pre-pull Testcontainers images
        run: |
          # é¢„æ‹‰å–å¸¸ç”¨çš„æµ‹è¯•é•œåƒï¼Œæé«˜ Testcontainers å¯åŠ¨é€Ÿåº¦
          docker pull postgres:15-alpine || true
          docker pull redis:7-alpine || true
          docker pull mysql:8.0 || true
          docker pull mongo:7 || true
          docker pull minio/minio:latest || true
          docker pull nginx:alpine || true

  # â˜• Setup JDK
  setup-jdk:
    name: "â˜• Setup JDK"
    runs-on: ubuntu-latest
    needs: setup-docker
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Verify Java installation
        run: |
          java -version
          javac -version

  # ğŸ”§ Setup Gradle
  setup-gradle:
    name: "ğŸ”§ Setup Gradle"
    runs-on: ubuntu-latest
    needs: setup-jdk
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.konan
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.0.0-rc-3'
          cache-read-only: false
          cache-cleanup: on-success

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Warm up Gradle daemon
        run: ./gradlew --version

  # ğŸ§ª Run All Tests
  run-tests:
    name: "ğŸ§ª Run All Tests"
    runs-on: ubuntu-latest
    needs: setup-gradle
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.konan
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.0.0-rc-3'
          cache-read-only: false
          cache-cleanup: on-success

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-docker-${{ hashFiles('**/Dockerfile*', '**/docker-compose*') }}
          restore-keys: |
            ${{ runner.os }}-docker-

      - name: Pre-pull Testcontainers images
        run: |
          docker pull postgres:15-alpine || true
          docker pull redis:7-alpine || true
          docker pull mysql:8.0 || true
          docker pull mongo:7 || true
          docker pull minio/minio:latest || true
          docker pull nginx:alpine || true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run all tests
        run: ./gradlew clean test --no-daemon --stacktrace --parallel --no-build-cache --no-configuration-cache --rerun-tasks
        env:
          # Testcontainers ä¼˜åŒ–é…ç½®
          TESTCONTAINERS_RYUK_DISABLED: false
          TESTCONTAINERS_CHECKS_DISABLE: false
          TESTCONTAINERS_REUSE_ENABLE: true
          TESTCONTAINERS_HUB_IMAGE_NAME_PREFIX: ""
          # å¯ç”¨å®¹å™¨é‡ç”¨æ ‡ç­¾ï¼Œæé«˜ç¼“å­˜æ•ˆç‡
          TESTCONTAINERS_REUSE_HASH_LABELS: true
          # Docker æ€§èƒ½ä¼˜åŒ–
          DOCKER_HOST: unix:///var/run/docker.sock
          TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE: /var/run/docker.sock
          TESTCONTAINERS_HOST_OVERRIDE: localhost
          # Docker é•œåƒç¼“å­˜ä¼˜åŒ–
          DOCKER_BUILDKIT: 1
          BUILDKIT_PROGRESS: plain
          # JVM æ€§èƒ½è°ƒä¼˜
          MAVEN_OPTS: "-Xmx2g -XX:+UseG1GC"
          # CI ç¯å¢ƒé…ç½®
          CI: true
          GRADLE_BUILD_ACTION_CACHE_DEBUG_ENABLED: true

      - name: Cleanup Docker containers
        if: always()
        run: |
          # æ¸…ç†åœæ­¢çš„å®¹å™¨ï¼Œä½†ä¿ç•™å¯é‡ç”¨çš„å®¹å™¨
          docker container prune -f --filter "until=1h" --filter "label!=org.testcontainers.reuse.enable=true"
          # ä¿ç•™å¸¸ç”¨é•œåƒï¼Œåªæ¸…ç†è¾ƒè€çš„é•œåƒ
          docker image prune -f --filter "until=48h" --filter "dangling=true"
          # æ¸…ç†æœªä½¿ç”¨çš„å·ï¼Œä½†ä¿ç•™æ ‡è®°ä¸ºä¿ç•™çš„å·
          docker volume prune -f --filter "label!=keep" --filter "label!=org.testcontainers"

      - name: Cache cleanup
        if: always()
        run: |
          # æ¸…ç†æ—§çš„ Gradle ç¼“å­˜æ–‡ä»¶
          find ~/.gradle/caches -name "*.lock" -delete || true
          find ~/.gradle/caches -type d -name "tmp" -exec rm -rf {} + || true
