name: Quick Check

on:
  push:
    branches: [ main, dev ]
    paths:
      - '.github/workflows/quick-check.yaml'
      - '**/*.kt'
      - '**/*.kts'
      - 'gradle/libs.versions.toml'
      - '**/build.gradle.kts'
  pull_request:
    branches: [ main, dev ]
    paths:
      - '.github/workflows/quick-check.yaml'
      - '**/*.kt'
      - '**/*.kts'
      - 'gradle/libs.versions.toml'
      - '**/build.gradle.kts'

# é˜²æ­¢åŒä¸€åˆ†æ”¯çš„å¤šæ¬¡å¹¶å‘æ‰§è¡Œ
concurrency:
  group: quick-check-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # ðŸš€ å¿«é€Ÿæ£€æŸ¥ä¸“ç”¨é…ç½® - æœ€å°åŒ–èµ„æºä½¿ç”¨å’Œæœ€å¤§åŒ–é€Ÿåº¦
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4 -Dkotlin.incremental=true -Dorg.gradle.configuration-cache=true -Dorg.gradle.build-cache=true"
  JVM_OPTS: "-Xmx3g -XX:MaxMetaspaceSize=768m -XX:+UseG1GC -XX:G1HeapRegionSize=16m"
  # ðŸ”§ CI çŽ¯å¢ƒæ ‡è¯†
  CI: true

jobs:
  # âš¡ è¶…å¿«é€Ÿè¯­æ³•å’Œç¼–è¯‘æ£€æŸ¥
  syntax-check:
    name: "âš¡ Syntax & Compile"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'graalvm'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.0.0'
          cache-read-only: false

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: âš¡ Gradle é…ç½®éªŒè¯
        run: |
          # éªŒè¯ Gradle é…ç½®å’Œé¡¹ç›®ç»“æž„
          ./gradlew help --quiet
          ./gradlew projects --quiet
          echo "âœ… Gradle é…ç½®éªŒè¯é€šè¿‡"

      - name: ðŸ” æ ¸å¿ƒæ¨¡å—ç¼–è¯‘æ£€æŸ¥
        run: |
          # ç¼–è¯‘æ ¸å¿ƒåŸºç¡€æ¨¡å—è¿›è¡Œå¿«é€ŸéªŒè¯
          ./gradlew :shared:compileKotlin :testtoolkit:testtoolkit-shared:compileKotlin \
            --no-daemon \
            --parallel \
            --build-cache \
            --configuration-cache \
            --quiet
          echo "âœ… æ ¸å¿ƒæ¨¡å—ç¼–è¯‘æˆåŠŸ"
        env:
          GRADLE_OPTS: "${{ env.GRADLE_OPTS }} ${{ env.JVM_OPTS }}"

  # ðŸ§¹ ä»£ç è´¨é‡å¿«é€Ÿæ£€æŸ¥ - ä¸Žæ ¸å¿ƒæµ‹è¯•å¹¶è¡Œæ‰§è¡Œ
  quality-check:
    name: "ðŸ§¹ Code Quality"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: syntax-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'graalvm'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.0.0'
          cache-read-only: true

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: ðŸ§¹ ä»£ç æ ¼å¼æ£€æŸ¥
        run: |
          ./gradlew spotlessCheck \
            --no-daemon \
            --parallel \
            --build-cache \
            --quiet
          echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
        env:
          GRADLE_OPTS: "${{ env.GRADLE_OPTS }} ${{ env.JVM_OPTS }}"

      - name: ðŸ“Š ä¾èµ–åˆ†æž
        run: |
          # åŸºç¡€ä¾èµ–ä¸€è‡´æ€§æ£€æŸ¥
          ./gradlew dependencies --quiet > /dev/null || echo "âš ï¸ ä¾èµ–æ£€æŸ¥å®Œæˆï¼ˆæœ‰è­¦å‘Šï¼‰"
          echo "âœ… ä¾èµ–åˆ†æžå®Œæˆ"
        continue-on-error: true

  # ðŸ§ª æ ¸å¿ƒæ¨¡å—å¿«é€Ÿæµ‹è¯•
  core-test:
    name: "ðŸ§ª Core Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: syntax-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'graalvm'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.0.0'
          cache-read-only: true

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: ðŸ§ª æ ¸å¿ƒæ¨¡å—æµ‹è¯•
        run: |
          # åªè¿è¡Œæ ¸å¿ƒåŸºç¡€æ¨¡å—çš„æµ‹è¯•
          ./gradlew :shared:test :testtoolkit:testtoolkit-shared:test \
            --no-daemon \
            --parallel \
            --build-cache \
            --configuration-cache \
            --quiet \
            -Dorg.gradle.workers.max=2
          echo "âœ… æ ¸å¿ƒæ¨¡å—æµ‹è¯•é€šè¿‡"
        env:
          GRADLE_OPTS: "${{ env.GRADLE_OPTS }} ${{ env.JVM_OPTS }}"

  # âœ… å¿«é€Ÿæ£€æŸ¥ç»“æžœæ±‡æ€»
  quick-check-result:
    name: "âœ… Quick Check Result"
    needs: [ syntax-check, quality-check, core-test ]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ç”Ÿæˆæ£€æŸ¥ç»“æžœæŠ¥å‘Š
        run: |
          echo "# âš¡ å¿«é€Ÿæ£€æŸ¥ç»“æžœæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**åˆ†æ”¯:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘äº‹ä»¶:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ” æ£€æŸ¥ç»“æžœè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ | è¯´æ˜Ž |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          # è¯­æ³•å’Œç¼–è¯‘æ£€æŸ¥
          if [[ "${{ needs.syntax-check.result }}" == "success" ]]; then
            echo "| ðŸ” è¯­æ³•ç¼–è¯‘ | âœ… é€šè¿‡ | Gradle é…ç½® + æ ¸å¿ƒæ¨¡å—ç¼–è¯‘ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ” è¯­æ³•ç¼–è¯‘ | âŒ å¤±è´¥ | æ£€æŸ¥ç¼–è¯‘é”™è¯¯å’Œ Gradle é…ç½® |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ä»£ç è´¨é‡æ£€æŸ¥
          if [[ "${{ needs.quality-check.result }}" == "success" ]]; then
            echo "| ðŸ§¹ ä»£ç è´¨é‡ | âœ… é€šè¿‡ | Spotless æ ¼å¼ + ä¾èµ–åˆ†æž |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ§¹ ä»£ç è´¨é‡ | âŒ å¤±è´¥ | è¿è¡Œ \`./gradlew spotlessApply\` ä¿®å¤æ ¼å¼ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ ¸å¿ƒæµ‹è¯•
          if [[ "${{ needs.core-test.result }}" == "success" ]]; then
            echo "| ðŸ§ª æ ¸å¿ƒæµ‹è¯• | âœ… é€šè¿‡ | shared + testtoolkit æ¨¡å—æµ‹è¯• |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ§ª æ ¸å¿ƒæµ‹è¯• | âŒ å¤±è´¥ | æ£€æŸ¥æµ‹è¯•æ—¥å¿—å’Œä¸šåŠ¡é€»è¾‘ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ€»ä½“çŠ¶æ€è¯„ä¼°
          all_passed=true
          if [[ "${{ needs.syntax-check.result }}" != "success" ]] || \
             [[ "${{ needs.quality-check.result }}" != "success" ]] || \
             [[ "${{ needs.core-test.result }}" != "success" ]]; then
            all_passed=false
          fi
          
          if [[ "$all_passed" == "true" ]]; then
            echo "## âœ… æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **æ‰€æœ‰å¿«é€Ÿæ£€æŸ¥éƒ½å·²é€šè¿‡ï¼**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ä»£ç ç¼–è¯‘æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ä»£ç æ ¼å¼è§„èŒƒ" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ å¯ä»¥å®‰å…¨åœ°è¿›è¡Œå®Œæ•´çš„ CI æµ‹è¯•æˆ–åˆå¹¶ä»£ç ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš¨ **å‘çŽ°é—®é¢˜ï¼Œè¯·ä¿®å¤åŽé‡è¯•ï¼š**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ å¸¸è§ä¿®å¤æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **ä»£ç æ ¼å¼é—®é¢˜**: è¿è¡Œ \`./gradlew spotlessApply\`" >> $GITHUB_STEP_SUMMARY
            echo "- **ç¼–è¯‘é”™è¯¯**: æ£€æŸ¥ Kotlin è¯­æ³•å’Œå¯¼å…¥" >> $GITHUB_STEP_SUMMARY
            echo "- **æµ‹è¯•å¤±è´¥**: æ£€æŸ¥ä¸šåŠ¡é€»è¾‘å’Œæµ‹è¯•ç”¨ä¾‹" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
