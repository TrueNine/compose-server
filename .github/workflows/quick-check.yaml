name: Quick Check

on:
  push:
    branches: [ main, dev ]
    paths:
      - '.github/workflows/quick-check.yaml'
      - '**/*.kt'
  pull_request:
    branches: [ main, dev ]
    paths:
      - '.github/workflows/quick-check.yaml'
      - '**/*.kt'

env:
  # ðŸš€ å¿«é€Ÿæ£€æŸ¥ä¸“ç”¨é…ç½® - æœ€å°åŒ–èµ„æºä½¿ç”¨
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4 -Dkotlin.incremental=true -Dorg.gradle.configuration-cache=true"
  JVM_OPTS: "-Xmx3g -XX:MaxMetaspaceSize=512m -XX:+UseG1GC"

jobs:
  # âš¡ è¶…å¿«é€Ÿè¯­æ³•å’Œç¼–è¯‘æ£€æŸ¥
  syntax-check:
    name: "âš¡ Syntax & Compile"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'graalvm'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.0.0'
          cache-read-only: false

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: âš¡ Quick syntax check
        run: |
          # åªæ£€æŸ¥è¯­æ³•ï¼Œä¸ç¼–è¯‘
          ./gradlew help --quiet
          ./gradlew tasks --quiet > /dev/null

      - name: ðŸ” Compile check (core modules only)
        run: |
          # åªç¼–è¯‘æ ¸å¿ƒæ¨¡å—è¿›è¡Œå¿«é€ŸéªŒè¯
          ./gradlew :shared:compileKotlin :testtoolkit:compileKotlin \
            --no-daemon \
            --parallel \
            --quiet

  # ðŸ§¹ ä»£ç è´¨é‡å¿«é€Ÿæ£€æŸ¥
  quality-check:
    name: "ðŸ§¹ Code Quality"
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: syntax-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'graalvm'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.0.0'
          cache-read-only: true

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: ðŸ§¹ Spotless check
        run: |
          ./gradlew spotlessCheck \
            --no-daemon \
            --parallel \
            --quiet

      - name: ðŸ“Š Basic dependency check
        run: |
          # å¿«é€Ÿä¾èµ–æ£€æŸ¥ï¼ˆä¸åŒ…å«æ¼æ´žæ‰«æï¼‰
          ./gradlew dependencies --configuration runtimeClasspath > /dev/null
        continue-on-error: true

  # ðŸ§ª æ ¸å¿ƒæ¨¡å—å¿«é€Ÿæµ‹è¯•
  core-test:
    name: "ðŸ§ª Core Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: syntax-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up JDK 24
        uses: actions/setup-java@v4
        with:
          java-version: '24'
          distribution: 'graalvm'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '9.0.0'
          cache-read-only: true

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: ðŸ§ª Run core tests
        run: |
          # åªè¿è¡Œæ ¸å¿ƒæ¨¡å—çš„æµ‹è¯•
          ./gradlew :shared:test :testtoolkit:test \
            --no-daemon \
            --parallel \
            --quiet \
            -Dorg.gradle.workers.max=2
        env:
          GRADLE_OPTS: "${{ env.GRADLE_OPTS }} ${{ env.JVM_OPTS }}"

  # âœ… å¿«é€Ÿæ£€æŸ¥ç»“æžœæ±‡æ€»
  quick-check-result:
    name: "âœ… Quick Check Result"
    needs: [ syntax-check, quality-check, core-test ]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "# âš¡ å¿«é€Ÿæ£€æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.syntax-check.result }}" == "success" ]]; then
            echo "| è¯­æ³•å’Œç¼–è¯‘ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| è¯­æ³•å’Œç¼–è¯‘ | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.quality-check.result }}" == "success" ]]; then
            echo "| ä»£ç è´¨é‡ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ä»£ç è´¨é‡ | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.core-test.result }}" == "success" ]]; then
            echo "| æ ¸å¿ƒæµ‹è¯• | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| æ ¸å¿ƒæµ‹è¯• | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ£€æŸ¥æ•´ä½“çŠ¶æ€
          if [[ "${{ needs.syntax-check.result }}" != "success" ]] || \
             [[ "${{ needs.quality-check.result }}" != "success" ]] || \
             [[ "${{ needs.core-test.result }}" != "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ å¿«é€Ÿæ£€æŸ¥å‘çŽ°é—®é¢˜ï¼Œè¯·ä¿®å¤åŽå†è¿›è¡Œå®Œæ•´æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… å¿«é€Ÿæ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼Œå¯ä»¥è¿›è¡Œå®Œæ•´æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          fi
